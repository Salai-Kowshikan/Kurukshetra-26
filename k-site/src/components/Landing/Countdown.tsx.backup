import { useState, useEffect, useRef } from 'react';

export default function Countdown() {
	const [timeLeft, setTimeLeft] = useState({
		days: 0,
		hours: 0,
		minutes: 0,
		seconds: 0
	});
	const [glitchActive, setGlitchActive] = useState(false);
	const containerRef = useRef<HTMLDivElement>(null);

	useEffect(() => {
		// Set your event date here (example: March 15, 2026)
		const eventDate = new Date('2026-03-15T00:00:00').getTime();

		const timer = setInterval(() => {
			const now = new Date().getTime();
			const distance = eventDate - now;

			if (distance < 0) {
				clearInterval(timer);
				setTimeLeft({ days: 0, hours: 0, minutes: 0, seconds: 0 });
				return;
			}

			setTimeLeft({
				days: Math.floor(distance / (1000 * 60 * 60 * 24)),
				hours: Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)),
				minutes: Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)),
				seconds: Math.floor((distance % (1000 * 60)) / 1000)
			});
		}, 1000);

		return () => clearInterval(timer);
	}, []);

	// Purple cyberpunk glitch bursts (2-4 seconds interval, 300-500ms duration)
	useEffect(() => {
		const triggerGlitch = () => {
			setGlitchActive(true);
			const duration = 300 + Math.random() * 200; // 300-500ms
			setTimeout(() => setGlitchActive(false), duration);
		};

		const scheduleNextGlitch = () => {
			const delay = 2000 + Math.random() * 2000; // 2-4 seconds
			return setTimeout(triggerGlitch, delay);
		};

		let timeoutId = scheduleNextGlitch();

		return () => clearTimeout(timeoutId);
	}, [glitchActive]); // Re-schedule after each glitch completes
		return String(num).padStart(2, '0').split('');
	};

	const TimeBox = ({ value, label }: { value: number; label: string }) => {
		const digits = formatNumber(value);
		
		return (
			<div className="flex flex-col items-center">
				<div className="relative rounded-2xl border-2 border-transparent bg-gradient-to-br from-purple-500 via-pink-500 to-purple-600 p-[2px]">
					<div className="bg-black rounded-2xl px-6 py-8 flex items-center justify-center gap-2 relative overflow-hidden retro-scanline">
						{/* Pixelated glitch overlay effects */}
						{glitching && (
							<>
								<div 
									className="absolute inset-0 bg-cyan-500 opacity-30"
									style={{
										clipPath: `inset(${Math.floor(Math.random() * 5) * 20}% 0 ${Math.floor(Math.random() * 5) * 20}% 0)`,
										animation: 'glitch1 0.15s steps(3) infinite',
										mixBlendMode: 'screen'
									}}
								/>
								<div 
									className="absolute inset-0 bg-red-500 opacity-30"
									style={{
										clipPath: `inset(${Math.floor(Math.random() * 5) * 20}% 0 ${Math.floor(Math.random() * 5) * 20}% 0)`,
										animation: 'glitch2 0.1s steps(3) infinite',
										mixBlendMode: 'screen'
									}}
								/>
								{/* Pixelated block overlay */}
								<div 
									className="absolute inset-0 opacity-40"
									style={{
										background: `repeating-linear-gradient(
											0deg,
											transparent 0px,
											rgba(0, 255, 255, 0.3) ${Math.floor(Math.random() * 10) + 5}px,
											transparent ${Math.floor(Math.random() * 10) + 10}px
										)`,
										animation: 'pixel-shift 0.1s steps(2) infinite'
									}}
								/>
							</>
						)}
						
						{digits.map((digit, idx) => (
							<div
								key={idx}
								className="relative text-6xl md:text-7xl font-bold pixel-border"
								style={{
									fontFamily: glitching ? "'Press Start 2P', monospace" : "'VT323', monospace",
									fontSize: glitching ? '3.5rem' : '5rem',
									letterSpacing: '0.1em'
								}}
							>
								{/* Main digit with retro effect */}
								<span
									className={`relative z-10 ${glitching ? 'animate-pixel-shift' : ''}`}
									style={{
										color: '#ffffff',
										textShadow: glitching 
											? '-3px 0 0 #ff00ff, 3px 0 0 #00ffff, 0 0 20px #ff00ff, 0 0 30px #00ffff'
											: '0 0 20px rgba(168, 85, 247, 0.8), 0 4px 0 rgba(168, 85, 247, 0.5)',
										filter: glitching ? 'contrast(1.2) brightness(1.3)' : 'none',
										transition: 'none',
										imageRendering: 'pixelated'
									}}
								>
									{digit}
								</span>
								
								{/* Retro pixelated ghost layers */}
								{glitching && (
									<>
										<span
											className="absolute top-0 left-0 z-0 animate-pixel-shift"
											style={{
												color: '#ff00ff',
												textShadow: '0 0 15px #ff00ff',
												transform: `translate(${Math.floor(Math.random() * 3) * 2 - 2}px, ${Math.floor(Math.random() * 3) * 2 - 2}px)`,
												opacity: 0.8,
												fontFamily: "'Press Start 2P', monospace",
												fontSize: '3.5rem'
											}}
										>
											{digit}
										</span>
										<span
											className="absolute top-0 left-0 z-0"
											style={{
												color: '#00ffff',
												textShadow: '0 0 15px #00ffff',
												transform: `translate(${Math.floor(Math.random() * 3) * 2 - 2}px, ${Math.floor(Math.random() * 3) * 2 - 2}px)`,
												opacity: 0.8,
												fontFamily: "'Press Start 2P', monospace",
												fontSize: '3.5rem',
												animation: 'pixel-shift 0.15s steps(2) infinite'
											}}
										>
											{digit}
										</span>
										{/* Blocky glitch artifact */}
										<span
											className="absolute top-0 left-0 z-0"
											style={{
												color: '#ffff00',
												textShadow: '0 0 10px #ffff00',
												transform: `translate(${Math.floor(Math.random() * 5) - 2}px, ${Math.floor(Math.random() * 5) - 2}px) scale(${0.95 + Math.random() * 0.1})`,
												opacity: 0.4,
												fontFamily: "'Press Start 2P', monospace",
												fontSize: '3.5rem',
												filter: 'blur(1px)'
											}}
										>
											{Math.floor(Math.random() * 10)}
										</span>
									</>
								)}
							</div>
						))}
					</div>
				</div>
				<p 
					className={`text-white text-lg md:text-xl font-bold mt-3 uppercase tracking-wider ${glitching ? 'animate-pulse' : ''}`}
					style={{
						fontFamily: "'Press Start 2P', monospace",
						fontSize: '0.875rem',
						textShadow: glitching ? '0 0 10px #ff00ff, 0 0 20px #00ffff' : '0 2px 4px rgba(0,0,0,0.5)',
						imageRendering: 'pixelated'
					}}
				>
					{label}
				</p>
			</div>
		);
	};

	return (
		<section className="w-full py-12 md:py-20 flex flex-col items-center bg-black">
			<div className="flex items-center gap-4 md:gap-8">
				<TimeBox value={timeLeft.days} label="Days" />
				<span className="text-white text-4xl md:text-5xl font-bold mb-8">:</span>
				<TimeBox value={timeLeft.hours} label="Hours" />
				<span className="text-white text-4xl md:text-5xl font-bold mb-8">:</span>
				<TimeBox value={timeLeft.minutes} label="Mins" />
				<span className="text-white text-4xl md:text-5xl font-bold mb-8">:</span>
				<TimeBox value={timeLeft.seconds} label="Sec" />
			</div>
		</section>
	);
}
